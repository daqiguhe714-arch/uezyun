<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åº—å“¡ç”¨ é †ç•ªç®¡ç†</title>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<style>
*{box-sizing:border-box;}
body{font-family:system-ui;background:#f2f2f2;padding:10px;}
h2{text-align:center;}

.box{background:#fff;border-radius:12px;padding:12px;margin-bottom:10px;}
.row{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
button{border:none;padding:8px 12px;border-radius:8px;cursor:pointer;}

.call{background:#4caf50;color:#fff;}
.absent{background:#ff9800;color:#fff;}
.done{background:#999;color:#fff;}
.mail{background:#2196f3;color:#fff;}
.undo{background:#673ab7;color:#fff;}

.small{font-size:13px;color:#555;margin-top:4px;}
input,select{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%;}

.section{background:#fff;border-radius:12px;padding:12px;margin:12px 0;}
.badge{padding:3px 8px;border-radius:6px;font-size:12px;}
.badge-absent{background:#ff9800;color:#fff;}
.badge-sent{background:#4caf50;color:#fff;}
.hidden{display:none;}

.summary{
  display:flex;
  gap:10px;
  font-weight:bold;
}
.summary div{
  background:#e3f2fd;
  padding:10px;
  border-radius:10px;
  width:100%;
  text-align:center;
}

.history-item{
  margin-bottom:8px;
  padding:8px;
  background:#f9f9f9;
  border-radius:6px;
  font-size:14px;
}
</style>

<script>
const PASS="1793";
if(sessionStorage.getItem("auth")!=="ok"){
  const p=prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(p!==PASS){alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");location.reload();}
  else sessionStorage.setItem("auth","ok");
}

emailjs.init({ publicKey:"jRUkbLl4MWL20uTZR" });
</script>
</head>

<body>

<h2>é †ç•ªç®¡ç†ï¼ˆåº—å“¡ç”¨ï¼‰</h2>

<div class="section summary">
  <div>å¾…ã¡çµ„æ•°<br><span id="groupCount">0</span> çµ„</div>
  <div>åˆè¨ˆäººæ•°<br><span id="peopleCount">0</span> äºº</div>
</div>

<div class="section">
  <h3>â° ç¾åœ¨ã®å¾…ã¡æ™‚é–“ï¼ˆåˆ†ï¼‰</h3>
  <div style="display:flex;gap:6px;">
    <input id="waitMin" type="number" placeholder="æœ€çŸ­(åˆ†)">
    <input id="waitMax" type="number" placeholder="æœ€é•·(åˆ†)">
    <button onclick="saveWaitTime()" style="background:#4caf50;color:#fff;">æ›´æ–°</button>
  </div>
  <div id="waitTimeStatus" style="margin-top:8px;font-size:13px;color:#666;"></div>
</div>

<button onclick="toggleStaffForm()">â• åº—å“¡å—ä»˜</button>

<div id="staffForm" class="section hidden">
  <label>åå‰</label>
  <input id="s_name">
  <label>äººæ•°</label>
  <input id="s_count" type="number">
  <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
  <input id="s_email" type="email">
  <label>å‚™è€ƒ</label>
  <input id="s_note">
  <button onclick="staffRegister()">å—ä»˜ã™ã‚‹</button>
</div>

<div id="list"></div>

<div class="section">
<h3>ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡å±¥æ­´</h3>
<div id="mailHistory"></div>
</div>

<div class="section">
<h3>ğŸ“¢ å‘¼ã³å‡ºã—å±¥æ­´</h3>
<div id="callHistory"></div>
</div>

<div class="section">
<h3>ğŸ—‘ æ¶ˆå»å±¥æ­´</h3>
<div id="deleteHistory"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, update, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app=initializeApp({
  databaseURL:"https://zyunule-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=getDatabase(app);

const list=document.getElementById("list");
const groupCount=document.getElementById("groupCount");
const peopleCount=document.getElementById("peopleCount");
const callHistory=document.getElementById("callHistory");
const deleteHistory=document.getElementById("deleteHistory");
const mailHistory=document.getElementById("mailHistory");
const waitMinInput=document.getElementById("waitMin");
const waitMaxInput=document.getElementById("waitMax");
const waitTimeStatus=document.getElementById("waitTimeStatus");

// å¾…ã¡æ™‚é–“ã®ç¾åœ¨å€¤ã‚’èª­ã¿è¾¼ã¿
onValue(ref(db,"status/waitTime"),snap=>{
  const d=snap.val();
  if(d){
    waitMinInput.value=d.min||'';
    waitMaxInput.value=d.max||'';
    waitTimeStatus.textContent=`ç¾åœ¨ã®è¨­å®š: ${d.min}åˆ† ï½ ${d.max}åˆ†`;
  }
});

// å±¥æ­´ã®èª­ã¿è¾¼ã¿
onValue(ref(db,"history/mail"),snap=>{
  mailHistory.innerHTML="";
  const d=snap.val();
  if(!d)return;
  
  Object.entries(d).sort((a,b)=>b[1].time-a[1].time).slice(0,20).forEach(([key,v])=>{
    const div=document.createElement("div");
    div.className="history-item";
    div.textContent=`${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ï½œ${v.sender}`;
    mailHistory.appendChild(div);
  });
});

onValue(ref(db,"history/call"),snap=>{
  callHistory.innerHTML="";
  const d=snap.val();
  if(!d)return;
  
  Object.entries(d).sort((a,b)=>b[1].time-a[1].time).slice(0,20).forEach(([key,v])=>{
    const div=document.createElement("div");
    div.className="history-item";
    div.innerHTML=`${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ <button class="undo" onclick="undoCall('${key}',${JSON.stringify(v.data).replace(/"/g,'&quot;')})">æˆ»ã™</button>`;
    callHistory.appendChild(div);
  });
});

onValue(ref(db,"history/delete"),snap=>{
  deleteHistory.innerHTML="";
  const d=snap.val();
  if(!d)return;
  
  Object.entries(d).sort((a,b)=>b[1].time-a[1].time).slice(0,20).forEach(([key,v])=>{
    const div=document.createElement("div");
    div.className="history-item";
    div.innerHTML=`${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ <button class="undo" onclick="undoDelete('${key}',${JSON.stringify(v.data).replace(/"/g,'&quot;')})">æˆ»ã™</button>`;
    deleteHistory.appendChild(div);
  });
});

onValue(ref(db,"waitlist"),snap=>{
  list.innerHTML="";
  let g=0,p=0;
  const d=snap.val();
  if(!d){
    groupCount.textContent=0;
    peopleCount.textContent=0;
    return;
  }

  Object.entries(d).forEach(([key,v],i)=>{
    g++; p+=Number(v.count||0);
    const div=document.createElement("div");
    div.className="box";
    
    let kidsInfo = '';
    if(v.kids && v.kids !== '0'){
      kidsInfo += `<div class="small">ğŸ‘¶ å°å­¦ç”Ÿä»¥ä¸‹: ${v.kids}äºº</div>`;
    }
    if(v.chair && v.chair !== '0'){
      kidsInfo += `<div class="small">ğŸª‘ å­ä¾›ã„ã™: ${v.chair}å€‹</div>`;
    }
    
    div.innerHTML=`
      <b>${i+1}ç•ªç›®ï½œ${v.name} æ§˜ï¼ˆ${v.count}åï¼‰</b>
      ${v.absentAt?` <span class="badge badge-absent">ä¸åœ¨ ${new Date(v.absentAt).toLocaleTimeString()}</span>`:""}
      ${v.mailSent?` <span class="badge badge-sent">é€ä¿¡æ¸ˆã¿</span>`:""}
      ${v.email?` <span class="badge" style="background:#2196f3;color:#fff;">ğŸ“§</span>`:""}
      ${kidsInfo}
      <div class="small">å‚™è€ƒï¼š${v.note||"ãªã—"}</div>
      <div class="row">
        ${v.email&&!v.mailSent?`<button class="mail" onclick="sendMail('${key}','${v.name}','${v.email}')">ãƒ¡ãƒ¼ãƒ«</button>`:""}
        <button class="call" onclick="call('${key}','${v.name}')">å‘¼ã³å‡ºã—</button>
        <button class="absent" onclick="absent('${key}','${v.name}')">ä¸åœ¨</button>
        <button class="done" onclick="del('${key}','${v.name}')">æ¶ˆå»</button>
      </div>`;
    list.appendChild(div);
  });

  groupCount.textContent=g;
  peopleCount.textContent=p;
});

/* ===== ãƒ¡ãƒ¼ãƒ« ===== */
window.sendMail=(key,name,email)=>{
  const sender=prompt("é€ä¿¡è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!sender) return;

  emailjs.send("service_a01ep2i","template_mgk6u3t",{
    to_name:name,
    to_email:email,
    sender
  }).then(()=>{
    update(ref(db,"waitlist/"+key),{mailSent:true});
    
    // å±¥æ­´ã«ä¿å­˜
    push(ref(db,"history/mail"),{
      name,
      sender,
      time:Date.now()
    });
    
    alert("ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
  });
};

/* ===== å‘¼ã³å‡ºã— ===== */
window.call=(key,name)=>{
  if(!confirm("å‘¼ã³å‡ºã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  const itemRef = ref(db, "waitlist/" + key);
  onValue(itemRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      // å±¥æ­´ã«ä¿å­˜
      push(ref(db,"history/call"),{
        name,
        data,
        time:Date.now()
      });
      
      remove(itemRef);
    }
  }, { onlyOnce: true });
};

window.undoCall=(historyKey,data)=>{
  if(!confirm("å‘¼ã³å‡ºã—ã‚’å–ã‚Šæ¶ˆã—ã¦å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  // æ–°ã—ã„ã‚­ãƒ¼ã§å¾…ã¡åˆ—ã«è¿½åŠ 
  push(ref(db,"waitlist"),data);
  
  // å±¥æ­´ã‹ã‚‰å‰Šé™¤
  remove(ref(db,"history/call/"+historyKey));
  
  alert("å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã—ãŸ");
};

/* ===== ä¸åœ¨ ===== */
window.absent=(key,name)=>{
  if(!confirm("ä¸åœ¨ã«ã—ã¾ã™ã‹ï¼Ÿ"))return;
  const t=Date.now();
  update(ref(db,"waitlist/"+key),{absentAt:t});
  
  setTimeout(()=>{
    const itemRef = ref(db, "waitlist/" + key);
    onValue(itemRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        // å±¥æ­´ã«ä¿å­˜
        push(ref(db,"history/delete"),{
          name,
          data,
          reason:"ä¸åœ¨",
          time:Date.now()
        });
        
        remove(itemRef);
      }
    }, { onlyOnce: true });
  },15*60*1000);
};

/* ===== æ¶ˆå» ===== */
window.del=(key,name)=>{
  if(!confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  const itemRef = ref(db, "waitlist/" + key);
  onValue(itemRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      // å±¥æ­´ã«ä¿å­˜
      push(ref(db,"history/delete"),{
        name,
        data,
        time:Date.now()
      });
      
      remove(itemRef);
    }
  }, { onlyOnce: true });
};

window.undoDelete=(historyKey,data)=>{
  if(!confirm("æ¶ˆå»ã‚’å–ã‚Šæ¶ˆã—ã¦å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  // æ–°ã—ã„ã‚­ãƒ¼ã§å¾…ã¡åˆ—ã«è¿½åŠ 
  push(ref(db,"waitlist"),data);
  
  // å±¥æ­´ã‹ã‚‰å‰Šé™¤
  remove(ref(db,"history/delete/"+historyKey));
  
  alert("å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã—ãŸ");
};

/* ===== åº—å“¡å—ä»˜ ===== */
window.toggleStaffForm=()=>staffForm.classList.toggle("hidden");

window.staffRegister=()=>{
  if(!s_name.value||!s_count.value){
    alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  const data = {
    name:s_name.value,
    count:s_count.value,
    note:s_note.value,
    time:Date.now()
  };
  if(s_email.value) data.email = s_email.value;
  
  push(ref(db,"waitlist"), data);
  s_name.value = '';
  s_count.value = '';
  s_email.value = '';
  s_note.value = '';
  staffForm.classList.add("hidden");
  alert("å—ä»˜å®Œäº†ã—ã¾ã—ãŸ");
};

/* ===== å¾…ã¡æ™‚é–“æ›´æ–° ===== */
window.saveWaitTime=()=>{
  const min=Number(waitMinInput.value);
  const max=Number(waitMaxInput.value);
  
  if(!min||!max){
    alert("å¾…ã¡æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  
  if(min>max){
    alert("æœ€çŸ­æ™‚é–“ã¯æœ€é•·æ™‚é–“ã‚ˆã‚Šå°ã•ãã—ã¦ãã ã•ã„");
    return;
  }
  
  set(ref(db,"status/waitTime"),{min,max}).then(()=>{
    waitTimeStatus.textContent=`ç¾åœ¨ã®è¨­å®š: ${min}åˆ† ï½ ${max}åˆ†`;
    alert("å¾…ã¡æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
  }).catch(err=>{
    alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: "+err.message);
  });
};
</script>
</body>
</html>