<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åº—å“¡ç”¨ é †ç•ªç®¡ç†</title>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<style>
*{box-sizing:border-box;}
body{font-family:system-ui;background:#f2f2f2;padding:10px;}
h2{text-align:center;}

.box{background:#fff;border-radius:12px;padding:12px;margin-bottom:10px;}
.row{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
button{border:none;padding:8px 12px;border-radius:8px;cursor:pointer;}

.call{background:#4caf50;color:#fff;}
.absent{background:#ff9800;color:#fff;}
.done{background:#999;color:#fff;}
.mail{background:#2196f3;color:#fff;}
.undo{background:#673ab7;color:#fff;}

.small{font-size:13px;color:#555;margin-top:4px;}
input,select{padding:8px;border-radius:8px;border:1px solid #ccc;width:100%;}

.section{background:#fff;border-radius:12px;padding:12px;margin:12px 0;}
.badge{padding:3px 8px;border-radius:6px;font-size:12px;}
.badge-absent{background:#ff9800;color:#fff;}
.badge-sent{background:#4caf50;color:#fff;}
.hidden{display:none;}

.summary{
  display:flex;
  gap:10px;
  font-weight:bold;
}
.summary div{
  background:#e3f2fd;
  padding:10px;
  border-radius:10px;
  width:100%;
  text-align:center;
}

.history-item{
  margin-bottom:8px;
  padding:8px;
  background:#f9f9f9;
  border-radius:6px;
  font-size:14px;
}

.date-section{
  background:#fff;
  border-radius:12px;
  padding:12px;
  margin:12px 0;
  border-left:4px solid #2196f3;
}
.date-header{
  font-weight:bold;
  font-size:16px;
  color:#2196f3;
  margin-bottom:12px;
  padding-bottom:8px;
  border-bottom:1px solid #e0e0e0;
}
.archive-box{
  background:#f9f9f9;
  padding:10px;
  border-radius:8px;
  margin-bottom:8px;
}
.archive-box h4{
  font-size:14px;
  color:#666;
  margin-bottom:8px;
}

.collapsible{
  cursor:pointer;
  user-select:none;
  display:flex;
  align-items:center;
  gap:8px;
  padding:4px 0;
}
.collapsible:hover{
  opacity:0.7;
}
.collapsible .arrow{
  transition:transform 0.3s;
  font-size:12px;
}
.collapsible.open .arrow{
  transform:rotate(90deg);
}
.collapsible-content{
  max-height:0;
  overflow:hidden;
  transition:max-height 0.3s ease;
}
.collapsible-content.open{
  max-height:2000px;
}
</style>

<script>
const PASS="1793";
if(sessionStorage.getItem("auth")!=="ok"){
  const p=prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(p!==PASS){alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");location.reload();}
  else sessionStorage.setItem("auth","ok");
}

emailjs.init({ publicKey:"jRUkbLl4MWL20uTZR" });
</script>
</head>

<body>

<h2>é †ç•ªç®¡ç†ï¼ˆåº—å“¡ç”¨ï¼‰</h2>

<div class="section summary">
  <div>å¾…ã¡çµ„æ•°<br><span id="groupCount">0</span> çµ„</div>
  <div>åˆè¨ˆäººæ•°<br><span id="peopleCount">0</span> äºº</div>
</div>

<div class="section">
  <h3>ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹</h3>
  <button id="toggleSystemBtn" onclick="toggleSystem()" style="width:100%;padding:12px;font-size:16px;font-weight:bold;margin-bottom:8px;">
    èª­è¾¼ä¸­...
  </button>
  <div id="systemStatus" style="text-align:center;font-size:13px;color:#666;"></div>
</div>

<div class="section" id="waitTimeSection">
  <h3>â° ç¾åœ¨ã®å¾…ã¡æ™‚é–“ï¼ˆåˆ†ï¼‰</h3>
  <div style="display:flex;gap:6px;">
    <input id="waitMin" type="number" placeholder="æœ€çŸ­(åˆ†)">
    <input id="waitMax" type="number" placeholder="æœ€é•·(åˆ†)">
    <button onclick="saveWaitTime()" style="background:#4caf50;color:#fff;">æ›´æ–°</button>
  </div>
  <div id="waitTimeStatus" style="margin-top:8px;font-size:13px;color:#666;"></div>
</div>

<button onclick="toggleStaffForm()">â• åº—å“¡å—ä»˜</button>

<div id="staffForm" class="section hidden">
  <label>åå‰</label>
  <input id="s_name">
  <label>äººæ•°</label>
  <input id="s_count" type="number">
  <label>ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆä»»æ„ï¼‰</label>
  <input id="s_email" type="email">
  <label>å‚™è€ƒ</label>
  <input id="s_note">
  <button onclick="staffRegister()">å—ä»˜ã™ã‚‹</button>
</div>

<div id="list"></div>

<div class="section">
<div class="collapsible" onclick="toggleSection('mailHistory')">
<span class="arrow">â–¶</span>
<h3 style="margin:0;">ğŸ“§ æœ¬æ—¥ã®ãƒ¡ãƒ¼ãƒ«é€ä¿¡å±¥æ­´</h3>
</div>
<div class="collapsible-content" id="mailHistory-content">
<div id="mailHistory" style="margin-top:12px;"></div>
</div>
</div>

<div class="section">
<div class="collapsible" onclick="toggleSection('callHistory')">
<span class="arrow">â–¶</span>
<h3 style="margin:0;">ğŸ“¢ æœ¬æ—¥ã®å‘¼ã³å‡ºã—å±¥æ­´</h3>
</div>
<div class="collapsible-content" id="callHistory-content">
<div id="callHistory" style="margin-top:12px;"></div>
</div>
</div>

<div class="section">
<div class="collapsible" onclick="toggleSection('deleteHistory')">
<span class="arrow">â–¶</span>
<h3 style="margin:0;">ğŸ—‘ æœ¬æ—¥ã®æ¶ˆå»å±¥æ­´</h3>
</div>
<div class="collapsible-content" id="deleteHistory-content">
<div id="deleteHistory" style="margin-top:12px;"></div>
</div>
</div>

<div class="section">
<div class="collapsible" onclick="toggleSection('cancelHistory')">
<span class="arrow">â–¶</span>
<h3 style="margin:0;">âŒ æœ¬æ—¥ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ï¼ˆä¸åœ¨30åˆ†å¾Œï¼‰</h3>
</div>
<div class="collapsible-content" id="cancelHistory-content">
<div id="cancelHistory" style="margin-top:12px;"></div>
</div>
</div>

<div class="section">
<div class="collapsible" onclick="toggleSection('archiveHistory')">
<span class="arrow">â–¶</span>
<h3 style="margin:0;">ğŸ“¦ éå»ã®å±¥æ­´ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–</h3>
</div>
<div class="collapsible-content" id="archiveHistory-content">
<div id="archiveHistory" style="margin-top:12px;"></div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, push, remove, update, set, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const app=initializeApp({
  databaseURL:"https://zyunule-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db=getDatabase(app);

const list=document.getElementById("list");
const groupCount=document.getElementById("groupCount");
const peopleCount=document.getElementById("peopleCount");
const callHistory=document.getElementById("callHistory");
const deleteHistory=document.getElementById("deleteHistory");
const cancelHistory=document.getElementById("cancelHistory");
const mailHistory=document.getElementById("mailHistory");
const archiveHistory=document.getElementById("archiveHistory");
const waitMinInput=document.getElementById("waitMin");
const waitMaxInput=document.getElementById("waitMax");
const waitTimeStatus=document.getElementById("waitTimeStatus");
const toggleSystemBtn=document.getElementById("toggleSystemBtn");
const systemStatus=document.getElementById("systemStatus");
const waitTimeSection=document.getElementById("waitTimeSection");

let currentSystemState = false;

/* ===== ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ãƒˆã‚°ãƒ« ===== */
window.toggleSection = (id) => {
  const content = document.getElementById(id + '-content');
  const parent = content.previousElementSibling;
  
  content.classList.toggle('open');
  parent.classList.toggle('open');
};

/* ===== æ—¥ä»˜å–å¾—é–¢æ•° ===== */
const getDateString = (timestamp) => {
  const d = new Date(timestamp || Date.now());
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
};

const formatDateJP = (dateStr) => {
  const [y,m,d] = dateStr.split('-');
  return `${y}å¹´${m}æœˆ${d}æ—¥`;
};

/* ===== 0æ™‚ã®è‡ªå‹•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç† ===== */
const checkAndArchive = async () => {
  const now = new Date();
  const today = getDateString();
  
  // æœ€å¾Œã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ãŸæ—¥ä»˜ã‚’ç¢ºèª
  const lastArchiveSnap = await get(ref(db, "status/lastArchive"));
  const lastArchive = lastArchiveSnap.val();
  
  // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å®Ÿè¡Œ
  if(lastArchive !== today){
    await archiveData(lastArchive || today);
    await set(ref(db, "status/lastArchive"), today);
  }
};

const archiveData = async (dateStr) => {
  try {
    // å„å±¥æ­´ã‚’å–å¾—
    const mailSnap = await get(ref(db, "history/mail"));
    const callSnap = await get(ref(db, "history/call"));
    const deleteSnap = await get(ref(db, "history/delete"));
    const cancelSnap = await get(ref(db, "history/cancel"));
    
    const mailData = mailSnap.val();
    const callData = callSnap.val();
    const deleteData = deleteSnap.val();
    const cancelData = cancelSnap.val();
    
    // ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ä¿å­˜
    if(mailData || callData || deleteData || cancelData){
      await set(ref(db, `archive/${dateStr}`), {
        mail: mailData || {},
        call: callData || {},
        delete: deleteData || {},
        cancel: cancelData || {},
        archivedAt: Date.now()
      });
      
      // ç¾åœ¨ã®å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
      await set(ref(db, "history/mail"), null);
      await set(ref(db, "history/call"), null);
      await set(ref(db, "history/delete"), null);
      await set(ref(db, "history/cancel"), null);
      
      console.log(`${dateStr}ã®å±¥æ­´ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¾ã—ãŸ`);
    }
  } catch(err) {
    console.error("ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¨ãƒ©ãƒ¼:", err);
  }
};

// èµ·å‹•æ™‚ã¨ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã«ãƒã‚§ãƒƒã‚¯
checkAndArchive();
document.addEventListener('visibilitychange', () => {
  if(!document.hidden) checkAndArchive();
});

// å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯ï¼ˆ1åˆ†ã”ã¨ï¼‰
setInterval(checkAndArchive, 60000);

/* ===== ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å±¥æ­´ã®è¡¨ç¤º ===== */
onValue(ref(db, "archive"), snap => {
  archiveHistory.innerHTML = "";
  const data = snap.val();
  
  if(!data){
    archiveHistory.innerHTML = '<div style="color:#999;text-align:center;padding:20px;">éå»ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  // æ—¥ä»˜é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
  const dates = Object.keys(data).sort().reverse();
  
  dates.forEach(dateStr => {
    const dayData = data[dateStr];
    const dateDiv = document.createElement("div");
    dateDiv.className = "date-section";
    
    let content = `<div class="date-header">ğŸ“… ${formatDateJP(dateStr)}</div>`;
    
    // ãƒ¡ãƒ¼ãƒ«å±¥æ­´
    if(dayData.mail && Object.keys(dayData.mail).length > 0){
      content += `<div class="archive-box"><h4>ğŸ“§ ãƒ¡ãƒ¼ãƒ«é€ä¿¡ (${Object.keys(dayData.mail).length}ä»¶)</h4>`;
      Object.values(dayData.mail).slice(0,5).forEach(v => {
        content += `<div class="history-item">${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ï½œ${v.sender}</div>`;
      });
      content += `</div>`;
    }
    
    // å‘¼ã³å‡ºã—å±¥æ­´
    if(dayData.call && Object.keys(dayData.call).length > 0){
      content += `<div class="archive-box"><h4>ğŸ“¢ å‘¼ã³å‡ºã— (${Object.keys(dayData.call).length}ä»¶)</h4>`;
      Object.values(dayData.call).slice(0,5).forEach(v => {
        content += `<div class="history-item">${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜</div>`;
      });
      content += `</div>`;
    }
    
    // æ¶ˆå»å±¥æ­´
    if(dayData.delete && Object.keys(dayData.delete).length > 0){
      content += `<div class="archive-box"><h4>ğŸ—‘ æ¶ˆå» (${Object.keys(dayData.delete).length}ä»¶)</h4>`;
      Object.values(dayData.delete).slice(0,5).forEach(v => {
        content += `<div class="history-item">${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜</div>`;
      });
      content += `</div>`;
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´
    if(dayData.cancel && Object.keys(dayData.cancel).length > 0){
      content += `<div class="archive-box"><h4>âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ« (${Object.keys(dayData.cancel).length}ä»¶)</h4>`;
      Object.values(dayData.cancel).slice(0,5).forEach(v => {
        content += `<div class="history-item">${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ï¼ˆä¸åœ¨30åˆ†å¾Œè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰</div>`;
      });
      content += `</div>`;
    }
    
    dateDiv.innerHTML = content;
    archiveHistory.appendChild(dateDiv);
  });
});

// ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã®ç›£è¦–
onValue(ref(db,"status/isOpen"),snap=>{
  currentSystemState = snap.val() || false;
  updateSystemButton();
});

function updateSystemButton(){
  if(currentSystemState){
    toggleSystemBtn.textContent = "â¸ ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã™ã‚‹";
    toggleSystemBtn.style.background = "#ff9800";
    toggleSystemBtn.style.color = "#fff";
    systemStatus.textContent = "âœ… å—ä»˜ä¸­ï¼šãŠå®¢æ§˜ã¯å—ä»˜ã§ãã¾ã™";
    systemStatus.style.color = "#4caf50";
    waitTimeSection.classList.remove("hidden");
  } else {
    toggleSystemBtn.textContent = "â–¶ ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã™ã‚‹";
    toggleSystemBtn.style.background = "#4caf50";
    toggleSystemBtn.style.color = "#fff";
    systemStatus.textContent = "â¸ åœæ­¢ä¸­ï¼šãŠå®¢æ§˜ã¯å—ä»˜ã§ãã¾ã›ã‚“";
    systemStatus.style.color = "#999";
    waitTimeSection.classList.add("hidden");
  }
}

window.toggleSystem = ()=>{
  const newState = !currentSystemState;
  const msg = newState ? "ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ\nãŠå®¢æ§˜ãŒå—ä»˜ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚" : "ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã—ã¾ã™ã‹ï¼Ÿ\nãŠå®¢æ§˜ã¯å—ä»˜ã§ããªããªã‚Šã¾ã™ã€‚";
  
  if(!confirm(msg)) return;
  
  set(ref(db,"status/isOpen"), newState).then(()=>{
    alert(newState ? "ã‚·ã‚¹ãƒ†ãƒ ã‚’é–‹å§‹ã—ã¾ã—ãŸ" : "ã‚·ã‚¹ãƒ†ãƒ ã‚’åœæ­¢ã—ã¾ã—ãŸ");
  }).catch(err=>{
    alert("ã‚¨ãƒ©ãƒ¼: " + err.message);
  });
};

// å¾…ã¡æ™‚é–“ã®ç¾åœ¨å€¤ã‚’èª­ã¿è¾¼ã¿
onValue(ref(db,"status/waitTime"),snap=>{
  const d=snap.val();
  if(d){
    waitMinInput.value=d.min||'';
    waitMaxInput.value=d.max||'';
    waitTimeStatus.textContent=`ç¾åœ¨ã®è¨­å®š: ${d.min}åˆ† ï½ ${d.max}åˆ†`;
  }
});

// å±¥æ­´ã®èª­ã¿è¾¼ã¿
onValue(ref(db,"history/mail"),snap=>{
  mailHistory.innerHTML="";
  const d=snap.val();
  if(!d){
    mailHistory.innerHTML='<div style="color:#999;text-align:center;">å±¥æ­´ãªã—</div>';
    return;
  }
  
  Object.entries(d).sort((a,b)=>b[1].time-a[1].time).slice(0,20).forEach(([key,v])=>{
    const div=document.createElement("div");
    div.className="history-item";
    div.textContent=`${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ï½œ${v.sender}`;
    mailHistory.appendChild(div);
  });
});

onValue(ref(db,"history/call"),snap=>{
  callHistory.innerHTML="";
  const d=snap.val();
  if(!d){
    callHistory.innerHTML='<div style="color:#999;text-align:center;">å±¥æ­´ãªã—</div>';
    return;
  }
  
  Object.entries(d).sort((a,b)=>b[1].time-a[1].time).slice(0,20).forEach(([key,v])=>{
    const div=document.createElement("div");
    div.className="history-item";
    div.innerHTML=`${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ <button class="undo" onclick="undoCall('${key}',${JSON.stringify(v.data).replace(/"/g,'&quot;')})">æˆ»ã™</button>`;
    callHistory.appendChild(div);
  });
});

onValue(ref(db,"history/delete"),snap=>{
  deleteHistory.innerHTML="";
  const d=snap.val();
  if(!d){
    deleteHistory.innerHTML='<div style="color:#999;text-align:center;">å±¥æ­´ãªã—</div>';
    return;
  }
  
  Object.entries(d).sort((a,b)=>b[1].time-a[1].time).slice(0,20).forEach(([key,v])=>{
    const div=document.createElement("div");
    div.className="history-item";
    div.innerHTML=`${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ <button class="undo" onclick="undoDelete('${key}',${JSON.stringify(v.data).replace(/"/g,'&quot;')})">æˆ»ã™</button>`;
    deleteHistory.appendChild(div);
  });
});

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ã®èª­ã¿è¾¼ã¿
onValue(ref(db,"history/cancel"),snap=>{
  cancelHistory.innerHTML="";
  const d=snap.val();
  if(!d){
    cancelHistory.innerHTML='<div style="color:#999;text-align:center;">å±¥æ­´ãªã—</div>';
    return;
  }
  
  Object.entries(d).sort((a,b)=>b[1].time-a[1].time).slice(0,20).forEach(([key,v])=>{
    const div=document.createElement("div");
    div.className="history-item";
    div.innerHTML=`${new Date(v.time).toLocaleTimeString()}ï½œ${v.name}æ§˜ï¼ˆä¸åœ¨30åˆ†å¾Œè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰ <button class="undo" onclick="undoCancel('${key}',${JSON.stringify(v.data).replace(/"/g,'&quot;')})">æˆ»ã™</button>`;
    cancelHistory.appendChild(div);
  });
});

onValue(ref(db,"waitlist"),snap=>{
  list.innerHTML="";
  let g=0,p=0;
  const d=snap.val();
  if(!d){
    groupCount.textContent=0;
    peopleCount.textContent=0;
    return;
  }

  Object.entries(d).forEach(([key,v],i)=>{
    g++; p+=Number(v.count||0);
    const div=document.createElement("div");
    div.className="box";
    
    let kidsInfo = '';
    if(v.kids && v.kids !== '0'){
      kidsInfo += `<div class="small">ğŸ‘¶ å°å­¦ç”Ÿä»¥ä¸‹: ${v.kids}äºº</div>`;
    }
    if(v.chair && v.chair !== '0'){
      kidsInfo += `<div class="small">ğŸª‘ å­ä¾›ã„ã™: ${v.chair}å€‹</div>`;
    }
    
    div.innerHTML=`
      <b>${i+1}ç•ªç›®ï½œ${v.name} æ§˜ï¼ˆ${v.count}åï¼‰</b>
      ${v.absentAt?` <span class="badge badge-absent">ä¸åœ¨ ${new Date(v.absentAt).toLocaleTimeString()}</span>`:""}
      ${v.mailSent?` <span class="badge badge-sent">é€ä¿¡æ¸ˆã¿</span>`:""}
      ${v.email?` <span class="badge" style="background:#2196f3;color:#fff;">ğŸ“§</span>`:""}
      ${kidsInfo}
      <div class="small">å‚™è€ƒï¼š${v.note||"ãªã—"}</div>
      <div class="row">
        ${v.email&&!v.mailSent?`<button class="mail" onclick="sendMail('${key}','${v.name}','${v.email}')">ãƒ¡ãƒ¼ãƒ«</button>`:""}
        <button class="call" onclick="call('${key}','${v.name}')">å‘¼ã³å‡ºã—</button>
        <button class="absent" onclick="absent('${key}','${v.name}')">ä¸åœ¨</button>
        <button class="done" onclick="del('${key}','${v.name}')">æ¶ˆå»</button>
      </div>`;
    list.appendChild(div);
  });

  groupCount.textContent=g;
  peopleCount.textContent=p;
});

/* ===== ãƒ¡ãƒ¼ãƒ« ===== */
window.sendMail=(key,name,email)=>{
  const sender=prompt("é€ä¿¡è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!sender) return;

  emailjs.send("service_qg79zyi","template_mgk6u3t",{
    to_name:name,
    to_email:email,
    sender
  }).then(()=>{
    update(ref(db,"waitlist/"+key),{mailSent:true});
    
    // å±¥æ­´ã«ä¿å­˜
    push(ref(db,"history/mail"),{
      name,
      sender,
      time:Date.now()
    });
    
    alert("ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸ");
  }).catch(err=>{
    alert("ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼: " + err.text);
  });
};

/* ===== å‘¼ã³å‡ºã— ===== */
window.call=(key,name)=>{
  if(!confirm("å‘¼ã³å‡ºã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  const itemRef = ref(db, "waitlist/" + key);
  onValue(itemRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      // å±¥æ­´ã«ä¿å­˜
      push(ref(db,"history/call"),{
        name,
        data,
        time:Date.now()
      });
      
      remove(itemRef);
    }
  }, { onlyOnce: true });
};

window.undoCall=(historyKey,data)=>{
  if(!confirm("å‘¼ã³å‡ºã—ã‚’å–ã‚Šæ¶ˆã—ã¦å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  // æ–°ã—ã„ã‚­ãƒ¼ã§å¾…ã¡åˆ—ã«è¿½åŠ 
  push(ref(db,"waitlist"),data);
  
  // å±¥æ­´ã‹ã‚‰å‰Šé™¤
  remove(ref(db,"history/call/"+historyKey));
  
  alert("å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã—ãŸ");
};

/* ===== ä¸åœ¨ ===== */
window.absent=(key,name)=>{
  if(!confirm("ä¸åœ¨ã«ã—ã¾ã™ã‹ï¼Ÿ\n30åˆ†å¾Œã«è‡ªå‹•çš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã™ã€‚"))return;
  const t=Date.now();
  update(ref(db,"waitlist/"+key),{absentAt:t});
  
  // 30åˆ†å¾Œã«è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  setTimeout(()=>{
    const itemRef = ref(db, "waitlist/" + key);
    onValue(itemRef, (snapshot) => {
      const data = snapshot.val();
      if (data && data.absentAt === t) { // ã¾ã ä¸åœ¨çŠ¶æ…‹ã‹ç¢ºèª
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ã«ä¿å­˜
        push(ref(db,"history/cancel"),{
          name,
          data,
          reason:"ä¸åœ¨30åˆ†å¾Œè‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
          time:Date.now()
        });
        
        remove(itemRef);
        console.log(`${name}æ§˜ã‚’è‡ªå‹•ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ`);
      }
    }, { onlyOnce: true });
  },30*60*1000); // 30åˆ†
};

/* ===== æ¶ˆå» ===== */
window.del=(key,name)=>{
  if(!confirm("æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  const itemRef = ref(db, "waitlist/" + key);
  onValue(itemRef, (snapshot) => {
    const data = snapshot.val();
    if (data) {
      // å±¥æ­´ã«ä¿å­˜
      push(ref(db,"history/delete"),{
        name,
        data,
        time:Date.now()
      });
      
      remove(itemRef);
    }
  }, { onlyOnce: true });
};

window.undoDelete=(historyKey,data)=>{
  if(!confirm("æ¶ˆå»ã‚’å–ã‚Šæ¶ˆã—ã¦å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  // æ–°ã—ã„ã‚­ãƒ¼ã§å¾…ã¡åˆ—ã«è¿½åŠ 
  push(ref(db,"waitlist"),data);
  
  // å±¥æ­´ã‹ã‚‰å‰Šé™¤
  remove(ref(db,"history/delete/"+historyKey));
  
  alert("å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã—ãŸ");
};

window.undoCancel=(historyKey,data)=>{
  if(!confirm("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’å–ã‚Šæ¶ˆã—ã¦å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ"))return;
  
  // æ–°ã—ã„ã‚­ãƒ¼ã§å¾…ã¡åˆ—ã«è¿½åŠ ï¼ˆä¸åœ¨çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢ï¼‰
  const cleanData = {...data};
  delete cleanData.absentAt;
  push(ref(db,"waitlist"),cleanData);
  
  // å±¥æ­´ã‹ã‚‰å‰Šé™¤
  remove(ref(db,"history/cancel/"+historyKey));
  
  alert("å¾…ã¡åˆ—ã«æˆ»ã—ã¾ã—ãŸ");
};

/* ===== åº—å“¡å—ä»˜ ===== */
window.toggleStaffForm=()=>staffForm.classList.toggle("hidden");

window.staffRegister=()=>{
  if(!s_name.value||!s_count.value){
    alert("å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  const data = {
    name:s_name.value,
    count:s_count.value,
    note:s_note.value,
    time:Date.now()
  };
  if(s_email.value) data.email = s_email.value;
  
  push(ref(db,"waitlist"), data);
  s_name.value = '';
  s_count.value = '';
  s_email.value = '';
  s_note.value = '';
  staffForm.classList.add("hidden");
  alert("å—ä»˜å®Œäº†ã—ã¾ã—ãŸ");
};

/* ===== å¾…ã¡æ™‚é–“æ›´æ–° ===== */
window.saveWaitTime=()=>{
  const min=Number(waitMinInput.value);
  const max=Number(waitMaxInput.value);
  
  if(!min||!max){
    alert("å¾…ã¡æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }
  
  if(min>max){
    alert("æœ€çŸ­æ™‚é–“ã¯æœ€é•·æ™‚é–“ã‚ˆã‚Šå°ã•ãã—ã¦ãã ã•ã„");
    return;
  }
  
  set(ref(db,"status/waitTime"),{min,max}).then(()=>{
    waitTimeStatus.textContent=`ç¾åœ¨ã®è¨­å®š: ${min}åˆ† ï½ ${max}åˆ†`;
    alert("å¾…ã¡æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
  }).catch(err=>{
    alert("æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: "+err.message);
  });
};
</script>
</body>
</html>